<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>MX Liquidity Intelligence</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@multiversx/sdk-extension-provider@2.2.3/out/sdk-extension-provider.js"></script>

<style>

:root {

--bg: #0f172a;

--card: #1e293b;

--text: #e2e8f0;

--accent: #23f7dd;

--danger: #f43f5e;

--success: #10b981;

}

body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); }

.container { max-width: 1200px; margin: 0 auto; padding: 20px; }


/* Header */

header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }

h1 { margin: 0; font-size: 1.5rem; background: linear-gradient(90deg, var(--accent), #fff); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }

.btn { background: var(--accent); color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; }

.portfolio-header {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border: 1px solid var(--accent);
    display: flex;
    justify-content: space-around;
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 25px;
}


/* Grid Layout */

.dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }

.card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }


/* Table Styles */

table { width: 100%; border-collapse: collapse; margin-top: 10px; }

th { text-align: left; color: #94a3b8; padding: 10px; font-size: 0.9rem; }

td { padding: 10px; border-bottom: 1px solid #334155; }

tr:hover { background: #334155; cursor: pointer; }


/* Metrics */

.metric { display: flex; justify-content: space-between; margin-bottom: 10px; }

.metric label { color: #94a3b8; }

.tag { padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: bold; }

.risk-low { background: rgba(16, 185, 129, 0.2); color: var(--success); }

.risk-high { background: rgba(244, 63, 94, 0.2); color: var(--danger); }



/* Chart Container */

.chart-box { height: 300px; margin-top: 20px; }







/* Search & Calculator Styling */

.search-container { margin-bottom: 25px; display: flex; gap: 10px; }

.search-input {

flex: 1; padding: 12px; background: var(--card); border: 1px solid #334155;

border-radius: 8px; color: white; font-size: 1rem;

}

.calc-section {

margin-top: 25px; padding-top: 20px; border-top: 1px dashed #334155;

}

.calc-input-group { margin-bottom: 15px; }

.calc-input-group label { display: block; font-size: 0.8rem; color: #94a3b8; margin-bottom: 5px; }

.calc-input {

width: 100%; padding: 10px; background: #0f172a; border: 1px solid #334155;

border-radius: 4px; color: white; box-sizing: border-box;

}

.result-box {

margin-top: 15px; padding: 15px; border-radius: 8px; background: rgba(244, 63, 94, 0.1);

border: 1px solid rgba(244, 63, 94, 0.2);

}

</style>

</head>

<body>

<div class="container">

<header>

<div>

<h1>MX Liquidity Intelligence</h1>

<small>Real-time DeFi Analytics for MultiversX</small>

</div>

</header>



<div class="search-container">

<input type="text" id="targetAddress" class="search-input" placeholder="Enter erd1... address to audit portfolio">

<button class="btn" onclick="auditPortfolio()">Audit Address</button>

</div>



<!-- <div class="card" style="margin-bottom: 20px; display: flex; justify-content: space-around; background: linear-gradient(45deg, #1e293b, #23395b);">

<div style="text-align: center;">

<small style="color: #94a3b8;">Estimated Net Worth</small>

<div id="total-value" style="font-size: 2rem; color: var(--accent); font-weight: bold;">$0.00</div>

</div>

</div> -->

<div class="dashboard-grid">

<div class="card">

<h3>Liquidity Opportunities</h3>

<table>

<thead>

<tr>

<th>Pair</th>

<th>TVL</th>

<th>APR</th>

<th>Risk Score</th>

</tr>

</thead>

<tbody id="pool-table-body">

</tbody>

</table>

</div>



<div class="card" id="details-panel">

<h3>Select a pool to view analytics</h3>

<p style="color: #94a3b8;">Click on any row in the table to see Impermanent Loss projections and historical volatility.</p>

</div>

</div>

</div>





<script>
// --- CONFIG & STATE ---
const API_URL = 'http://localhost:3000/api';
let charts = {}; 

// --- DATA FETCHING ---
async function fetchPools() {
    try {
        const res = await fetch(`${API_URL}/pools`);
        const pools = await res.json();
        renderPools(pools);
    } catch (err) {
        console.error("Frontend could not reach Backend:", err);
    }
}

// --- LIVE PRICE FETCHING ---
async function getEGLDPrice() {
    try {
        const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=elrond-erd-2&vs_currencies=usd');
        const data = await response.json();
        const price = data['elrond-erd-2'].usd;
        console.log("Live EGLD Price Fetched:", price);
        return price;
    } catch (error) {
        console.error("Price fetch failed, using fallback:", error);
        return 42.50; 
    }
}

// --- PORTFOLIO AUDIT LOGIC (UPDATED) ---
async function auditPortfolio() {
    const inputField = document.getElementById('targetAddress');
    const addr = inputField.value.trim();

    if (addr.length < 62) return alert("Please enter a valid MultiversX address.");

    const detailsContainer = document.getElementById('details-panel');
    detailsContainer.innerHTML = `<p style="text-align:center; padding:50px;">üîç Fetching Live Market Data...</p>`;

    try {
        // 1. Get Live Price
        const livePrice = await getEGLDPrice();

        // 2. Fetch Account Data
        const apiBase = "https://devnet-api.multiversx.com";
        const [accRes, tokenRes] = await Promise.all([
            fetch(`${apiBase}/accounts/${addr}`),
            fetch(`${apiBase}/accounts/${addr}/tokens`)
        ]);

        if (!accRes.ok) throw new Error("Account not found");

        const accountData = await accRes.json();
        const tokens = tokenRes.ok ? await tokenRes.json() : [];

        // 3. Map Assets with Live Price
        const allAssets = [
            {
                ticker: "xEGLD",
                balance: accountData.balance,
                decimals: 18,
                price: livePrice, // <--- REAL PRICE APPLIED HERE
                type: "Native"
            },
            ...tokens.map(t => ({
                ...t,
                price: (t.ticker.includes("USDC") || t.ticker.includes("USDT")) ? 1.0 : 0.75
            }))
        ];

        renderAuditTable(allAssets);

    } catch (err) {
        console.error("Audit failed:", err);
        detailsContainer.innerHTML = `<p style="color: var(--danger)">Audit failed. Check console for details.</p>`;
    }
}

function renderAuditTable(assets) {
    const detailsPanel = document.getElementById('details-panel');
    const tableBody = document.getElementById('pool-table-body');
    let totalPortfolioValue = 0;

    tableBody.innerHTML = '';

    // 1. Calculate totals and find the "Heavy" asset
    let topAsset = { ticker: '', value: 0 };

    assets.forEach(asset => {
        const decimals = asset.decimals || 18;
        const balance = Number(asset.balance) / Math.pow(10, decimals);
        const price = asset.price || 0.75;
        const value = balance * price;
        totalPortfolioValue += value;

        if (value > topAsset.value) {
            topAsset = { ticker: asset.ticker, value: value };
        }

        const mockRisk = asset.type === "Native" ? 15 : 45; 

        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${asset.ticker}</strong><br><small>${asset.type || 'ESDT'}</small></td>
            <td>${balance.toLocaleString(undefined, {maximumFractionDigits: 4})}</td>
            <td style="color: var(--accent);">$${price.toFixed(2)}</td>
            <td><span style="color: #94a3b8;">Score:</span> ${mockRisk}/100</td>
        `;
        tableBody.appendChild(row);
    });

    // 2. AI STRATEGY LOGIC
    // We check if one asset is more than 60% of the portfolio (Concentration Risk)
    const concentration = (topAsset.value / totalPortfolioValue) * 100;
    let agentSuggestion = "";
    let statusColor = "var(--success)";

    if (concentration > 60 && topAsset.ticker !== 'USDC') {
        statusColor = "var(--danger)";
        agentSuggestion = `‚ö†Ô∏è <strong>High Concentration Risk:</strong> ${topAsset.ticker} makes up ${concentration.toFixed(1)}% of your holdings. Our AI recommends rebalancing 15% into a Stablecoin pool to hedge against volatility.`;
    } else if (totalPortfolioValue > 0) {
        agentSuggestion = `‚úÖ <strong>Portfolio Optimized:</strong> Your assets are well-distributed. Strategy: Stake your ${topAsset.ticker} in a Liquidity Pool to earn an estimated 12% APR in fees.`;
    } else {
        agentSuggestion = "Awaiting wallet data to generate strategy...";
    }

    // 3. UPDATE THE UI
    detailsPanel.innerHTML = `
        <div class="portfolio-header">
            <div class="stat">
                <small style="color: #94a3b8;">TOTAL MARKET VALUE</small>
                <div style="font-size: 1.5rem; color: var(--accent); font-weight: bold;">$${totalPortfolioValue.toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
            </div>
        </div>

        <div style="background: rgba(30, 41, 59, 0.5); border: 1px solid ${statusColor}; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span style="width: 8px; height: 8px; background: ${statusColor}; border-radius: 50%; display: inline-block;"></span>
                <small style="color: ${statusColor}; font-weight: bold; letter-spacing: 1px;">DEFI RISK AGENT</small>
            </div>
            <p style="font-size: 0.85rem; line-height: 1.4; margin: 0; color: #e2e8f0;">${agentSuggestion}</p>
        </div>

        <h4 style="margin-top: 25px;">Wallet Intelligence</h4>
        <p style="color: #94a3b8; font-size: 0.8rem;">Agent analysis complete. Market prices pulled live from CoinGecko API.</p>
        
        <button class="btn" style="width: 100%; margin-top: 10px;" onclick="location.reload()">Back to Opportunities</button>
    `;
}

// --- KEEP YOUR EXISTING RENDERPOOLS, SHOWDETAILS, RUNSIMULATION BELOW ---
function renderPools(pools) {
    const tableBody = document.getElementById('pool-table-body');
    if (!tableBody) return;
    tableBody.innerHTML = '';
    pools.forEach(pool => {
        let badgeColor = pool.risk_score > 60 ? '#f43f5e' : (pool.risk_score > 30 ? '#fbbf24' : '#10b981');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${pool.token_a} / ${pool.token_b}</strong></td>
            <td>$${Number(pool.tvl_usd).toLocaleString()}</td>
            <td style="color: #10b981;">${Number(pool.apr).toFixed(2)}%</td>
            <td>
                <span style="background: ${badgeColor}22; color: ${badgeColor}; padding: 4px 12px; border-radius: 20px; border: 1px solid ${badgeColor}; font-size: 0.8rem;">
                    ${Math.round(pool.risk_score)}/100
                </span>
            </td>
        `;
        row.onclick = () => showDetails(pool.address);
        tableBody.appendChild(row);
    });
}

async function showDetails(address) {
    const detailsContainer = document.getElementById('details-panel');
    detailsContainer.innerHTML = `<p style="text-align:center; padding:50px;">üì° Fetching Intelligence...</p>`;
    try {
        const res = await fetch(`${API_URL}/pool/${address}`);
        const data = await res.json();
        const { pool, history } = data;
        let advice = pool.risk_score > 40 ? "High Volatility. Monitor for Impermanent Loss." : "Consolidation phase. Safe for Fee Harvesting.";
        detailsContainer.innerHTML = `
            <div class="fade-in">
                <h3 style="color:var(--accent)">${pool.token_a} / ${pool.token_b}</h3>
                <div style="margin-bottom:15px;"><span class="tag ${pool.risk_score > 40 ? 'risk-high' : 'risk-low'}">AI SIGNAL: ${advice}</span></div>
                <div class="chart-box"><canvas id="priceChart"></canvas></div>
                <div class="calc-section">
                    <h4>üßÆ Smart IL Simulator</h4>
                    <div class="calc-input-group">
                        <label>Investment Amount ($)</label>
                        <input type="number" id="simAmount" class="calc-input" value="1000">
                    </div>
                    <div class="calc-input-group">
                        <label>Predicted Price Shift (%)</label>
                        <input type="range" id="simChange" min="-90" max="200" value="20" style="width:100%" oninput="this.nextElementSibling.value = this.value + '%'">
                        <output style="color:var(--accent)">20%</output>
                    </div>
                    <button class="btn" style="width:100%; margin-top:10px;" onclick="runSimulation()">Calculate Projected Risk</button>
                    <div id="sim-results"></div>
                </div>
            </div>
        `;
        renderChart(history);
    } catch (err) { detailsContainer.innerHTML = `<p style="color: var(--danger)">Failed to load intelligence.</p>`; }
}

function renderChart(history) {
    const canvas = document.getElementById('priceChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (charts.price) charts.price.destroy();
    charts.price = new Chart(ctx, {
        type: 'line',
        data: {
            labels: history.map(h => new Date(h.timestamp).toLocaleTimeString()),
            datasets: [{ label: 'Price Ratio', data: history.map(h => h.price_ratio), borderColor: '#23f7dd', tension: 0.4, fill: false }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

function runSimulation() {
    const amount = parseFloat(document.getElementById('simAmount').value);
    const change = parseFloat(document.getElementById('simChange').value);
    const r = 1 + (change / 100);
    const ilDecimal = (2 * Math.sqrt(r)) / (1 + r) - 1;
    const ilPercentage = (Math.abs(ilDecimal) * 100).toFixed(2);
    const lossUsd = (amount * Math.abs(ilDecimal)).toFixed(2);
    document.getElementById('sim-results').innerHTML = `
        <div class="result-box" style="border-color: var(--danger); background: rgba(244, 63, 94, 0.05);">
            <div style="color: var(--danger); font-weight: bold; font-size: 1.1rem;">Projected IL: -${ilPercentage}% (-$${lossUsd})</div>
            <p style="font-size: 0.8rem; color: #94a3b8; margin-top: 8px; line-height: 1.4;">
                ‚ö†Ô∏è <strong>Strategy Note:</strong> To be profitable, your earnings from this pool <span style="color: var(--accent)">must be offset by >${ilPercentage}%</span> in trading fees/rewards.
            </p>
        </div>
    `;
}

fetchPools();
</script>

</body>

</html>