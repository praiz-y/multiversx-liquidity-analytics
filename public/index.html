<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>MX Liquidity Intelligence</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@multiversx/sdk-extension-provider@2.2.3/out/sdk-extension-provider.js"></script>

    <style>

        :root {

        --bg: #0f172a;

        --card: #1e293b;

        --text: #e2e8f0;

        --accent: #23f7dd;

        --danger: #f43f5e;

        --success: #10b981;

        }

        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }


        /* Header */

/* Optimized Responsive Header */
header { 
    display: flex; 
    flex-direction: column; /* Stack H1 and Small vertically */
    align-items: center;    /* Center horizontally */
    text-align: center; 
    margin: 40px 0; 
}

h1 { 
    margin: 0; 
    /* clamp(min, preferred, max) - scales between 1.8rem and 3rem based on screen width */
    font-size: clamp(1.8rem, 5vw, 3rem); 
    font-weight: 800;
    letter-spacing: -1px;
    background: linear-gradient(90deg, var(--accent), #fff); 
    -webkit-background-clip: text; 
    background-clip: text; 
    -webkit-text-fill-color: transparent; 
    line-height: 1.2;
}

header small {
    display: block;
    margin-top: 10px;
    font-size: clamp(0.9rem, 2vw, 1.1rem);
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 2px;
}

/* Mobile Adjustments */
@media (max-width: 600px) {
    header { margin: 20px 0; }
    .dashboard-grid { grid-template-columns: 1fr; } /* Stack columns on mobile */
}

        .btn { background: var(--accent); color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; }

        .portfolio-header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid var(--accent);
            display: flex;
            justify-content: space-around;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
        }


        /* Grid Layout */

        .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }

        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }


        /* Table Styles */

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }

        th { text-align: left; color: #94a3b8; padding: 10px; font-size: 0.9rem; }

        td { padding: 10px; border-bottom: 1px solid #334155; }

        tr:hover { background: #334155; cursor: pointer; }


        /* Metrics */

        .metric { display: flex; justify-content: space-between; margin-bottom: 10px; }

        .metric label { color: #94a3b8; }

        .tag { padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: bold; }

        .risk-low { background: rgba(16, 185, 129, 0.2); color: var(--success); }

        .risk-high { background: rgba(244, 63, 94, 0.2); color: var(--danger); }



        /* Chart Container */

        .chart-box { height: 300px; margin-top: 20px; }







        /* Search & Calculator Styling */

        .search-container { margin-bottom: 25px; display: flex; gap: 10px; }

        .search-input {

        flex: 1; padding: 12px; background: var(--card); border: 1px solid #334155;

        border-radius: 8px; color: white; font-size: 1rem;

        }

        .calc-section {

        margin-top: 25px; padding-top: 20px; border-top: 1px dashed #334155;

        }

        .calc-input-group { margin-bottom: 15px; }

        .calc-input-group label { display: block; font-size: 0.8rem; color: #94a3b8; margin-bottom: 5px; }

        .calc-input {

        width: 100%; padding: 10px; background: #0f172a; border: 1px solid #334155;

        border-radius: 4px; color: white; box-sizing: border-box;

        }

        .result-box {

        margin-top: 15px; padding: 15px; border-radius: 8px; background: rgba(244, 63, 94, 0.1);

        border: 1px solid rgba(244, 63, 94, 0.2);

        }

    </style>

</head>

<body>

        <div class="container">

            <header>
                    <h1>MX Liquidity Intelligence</h1>
                    <small>Real-time DeFi Analytics for MultiversX</small>
            </header>



        <div class="search-container">

        <input type="text" id="targetAddress" class="search-input" placeholder="Enter erd1... address to audit portfolio">

        <button class="btn" onclick="auditPortfolio()">Audit Address</button>

        </div>





        <div class="dashboard-grid">

        <div class="card">

        <h3>Liquidity Opportunities</h3>

        <table>

        <thead>

        <tr>

            <th>Asset</th>
            <th>Balance</th>
            <th>Price</th>
            <th>Risk Level</th>

        </tr>

        </thead>

        <tbody id="pool-table-body">

        </tbody>

        </table>

        </div>



        <div class="card" id="details-panel">

        <h3>Select a pool to view analytics</h3>

        <p style="color: #94a3b8;">Click on any row in the table to see Impermanent Loss projections and historical volatility.</p>

        </div>

        </div>

    </div>





<script>

// --- CONFIG & STATE ---

const API_URL = '/api';

let charts = {};



// --- TOP OF YOUR JS FILE: Helper Functions ---



/** * This is the 'Discovery' function.

 * Place this at the top so other functions can use it.

 */

async function fetchLiveESDTPrices(identifiers) {

    if (identifiers.length === 0) return {};

    const addressList = identifiers.join(',');

    const url = `https://api.coingecko.com/api/v3/onchain/networks/elrond/tokens/multi/${addressList}`;



    try {

        const response = await fetch(url);

        const json = await response.json();

        const priceMap = {};

        if (json.data) {

            json.data.forEach(token => {

                priceMap[token.attributes.address] = parseFloat(token.attributes.price_usd);

            });

        }

        return priceMap;

    } catch (err) {

        console.error("CoinGecko Fetch Error:", err);

        return {};

    }

}



// --- MIDDLE OF YOUR JS FILE: Main Logic ---



async function auditPortfolio() {

    const addr = document.getElementById('targetAddress').value.trim();

    if (!addr) return alert("Enter an address");



    try {

        // 1. Fetch tokens from MultiversX

        const tokenRes = await fetch(`https://api.multiversx.com/accounts/${addr}/tokens`);

        const walletTokens = await tokenRes.json();



        // 2. Extract IDs and call the helper function above

        const idsToLookup = walletTokens.map(t => t.identifier);

        const priceData = await fetchLiveESDTPrices(idsToLookup);



        // 3. Map everything together

        const finalAssets = walletTokens.map(t => {

            const price = priceData[t.identifier] || 0;

            return {

                ticker: t.ticker,

                balance: t.balance / (10 ** (t.decimals || 18)),

                price: price,

                value: (t.balance / (10 ** (t.decimals || 18))) * price

            };

        });



        // 4. Update your UI Table

        renderAuditTable(finalAssets);



    } catch (err) {

        console.error("Audit Error:", err);

    }

}



// Add this at the very bottom of your script

setInterval(() => {

    if (document.getElementById('targetAddress').value) {

        auditPortfolio(); // Silently refreshes prices

    }

}, 60000); // 60,000ms = 1 minute





// --- DATA FETCHING ---

async function fetchPools() {

    try {

        const res = await fetch(`${API_URL}/pools`);

        const pools = await res.json();

        renderPools(pools);

    } catch (err) {

        console.error("Frontend could not reach Backend:", err);

    }

}



// --- LIVE PRICE FETCHING ---

async function getEGLDPrice() {

    try {

        const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=elrond-erd-2&vs_currencies=usd');

        const data = await response.json();

        const price = data['elrond-erd-2'].usd;

        console.log("Live EGLD Price Fetched:", price);

        return price;

    } catch (error) {

        console.error("Price fetch failed, using fallback:", error);

        return 42.50;

    }

}



// --- PORTFOLIO AUDIT LOGIC (UPDATED) ---

async function auditPortfolio() {

    const inputField = document.getElementById('targetAddress');

    const addr = inputField.value.trim();

    if (addr.length < 62) return alert("Please enter a valid address.");



    const detailsContainer = document.getElementById('details-panel');

    detailsContainer.innerHTML = `<p style="text-align:center; padding:50px;">üîç Syncing Live Market Prices...</p>`;



    try {

        const apiBase = "https://devnet-api.multiversx.com";

       

        // Parallel fetch for speed

        const [accRes, tokenRes, priceRes] = await Promise.all([

            fetch(`${apiBase}/accounts/${addr}`),

            fetch(`${apiBase}/accounts/${addr}/tokens?withPrice=true`),

            fetch(`${apiBase}/economics`)

        ]);



        const accountData = await accRes.json();

        const tokens = await tokenRes.json();

        const economics = await priceRes.json();

        const liveEgldPrice = economics.price || 42.50;



// ... inside your auditPortfolio function, after fetching tokens ...



const allAssets = [

    {

        ticker: "xEGLD",

        balance: accountData.balance,

        decimals: 18,

        price: economics.price || 42.50, // Real EGLD price

        type: "Native"

    },

    ...tokens.map(t => {

        let currentPrice = t.price || 0;

        const ticker = t.ticker.toUpperCase();



        // 1. FORCE STABLECOINS to $1.00

        if (ticker.includes("USDC") || ticker.includes("USDT")) {

            currentPrice = 1.00;

        }

        // 2. FORCE MEX to real-world price (since Devnet = 0)

        else if (ticker.includes("MEX") && currentPrice === 0) {

            currentPrice = 0.000001311; // Current real-world MEX price

        }



        return {

            ticker: t.ticker,

            balance: t.balance,

            decimals: t.decimals || 18,

            price: currentPrice,

            type: "ESDT"

        };

    })

];



        renderAuditTable(allAssets);



    } catch (err) {

        detailsContainer.innerHTML = `<p style="color: var(--danger)">Price Sync Failed. Try again.</p>`;

    }

}



function renderAuditTable(assets) {

    const detailsPanel = document.getElementById('details-panel');

    const tableBody = document.getElementById('pool-table-body');

    let totalPortfolioValue = 0;



    tableBody.innerHTML = '';



    // 1. Calculate totals and find the "Heavy" asset

    let topAsset = { ticker: '', value: 0 };



    assets.forEach(asset => {

        const decimals = asset.decimals || 18;

        const balance = Number(asset.balance) / Math.pow(10, decimals);

        const price = asset.price || 0.75;

        const value = balance * price;

        totalPortfolioValue += value;



        if (value > topAsset.value) {

            topAsset = { ticker: asset.ticker, value: value };

        }



        const mockRisk = asset.type === "Native" ? 15 : 45;



        const row = document.createElement('tr');

        row.innerHTML = `

            <td><strong>${asset.ticker}</strong><br><small>${asset.type || 'ESDT'}</small></td>

            <td>${balance.toLocaleString(undefined, {maximumFractionDigits: 4})}</td>

            <td style="color: var(--accent);">$${price.toFixed(2)}</td>

            <td><span style="color: #94a3b8;">Score:</span> ${mockRisk}/100</td>

        `;

        tableBody.appendChild(row);

    });



    // 2. AI STRATEGY LOGIC

    // We check if one asset is more than 60% of the portfolio (Concentration Risk)

    const concentration = (topAsset.value / totalPortfolioValue) * 100;

    let agentSuggestion = "";

    let statusColor = "var(--success)";



    if (concentration > 60 && topAsset.ticker !== 'USDC') {

        statusColor = "var(--danger)";

        agentSuggestion = `‚ö†Ô∏è <strong>High Concentration Risk:</strong> ${topAsset.ticker} makes up ${concentration.toFixed(1)}% of your holdings. Our AI recommends rebalancing 15% into a Stablecoin pool to hedge against volatility.`;

    } else if (totalPortfolioValue > 0) {

        agentSuggestion = `‚úÖ <strong>Portfolio Optimized:</strong> Your assets are well-distributed. Strategy: Stake your ${topAsset.ticker} in a Liquidity Pool to earn an estimated 12% APR in fees.`;

    } else {

        agentSuggestion = "Awaiting wallet data to generate strategy...";

    }



    // 3. UPDATE THE UI

    detailsPanel.innerHTML = `

        <div class="portfolio-header">

            <div class="stat">

                <small style="color: #94a3b8;">TOTAL MARKET VALUE</small>

                <div style="font-size: 1.5rem; color: var(--accent); font-weight: bold;">$${totalPortfolioValue.toLocaleString(undefined, {minimumFractionDigits: 2})}</div>

            </div>

        </div>



        <div style="background: rgba(30, 41, 59, 0.5); border: 1px solid ${statusColor}; padding: 15px; border-radius: 8px; margin-top: 15px;">

            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">

                <span style="width: 8px; height: 8px; background: ${statusColor}; border-radius: 50%; display: inline-block;"></span>

                <small style="color: ${statusColor}; font-weight: bold; letter-spacing: 1px;">DEFI RISK AGENT</small>

            </div>

            <p style="font-size: 0.85rem; line-height: 1.4; margin: 0; color: #e2e8f0;">${agentSuggestion}</p>

        </div>



    `;

}



// --- KEEP YOUR EXISTING RENDERPOOLS, SHOWDETAILS, RUNSIMULATION BELOW ---

function renderPools(pools) {

    const tableBody = document.getElementById('pool-table-body');

    if (!tableBody) return;

    tableBody.innerHTML = '';

    pools.forEach(pool => {

        let badgeColor = pool.risk_score > 60 ? '#f43f5e' : (pool.risk_score > 30 ? '#fbbf24' : '#10b981');

        const row = document.createElement('tr');

        row.innerHTML = `

            <td><strong>${pool.token_a} / ${pool.token_b}</strong></td>

            <td>$${Number(pool.tvl_usd).toLocaleString()}</td>

            <td style="color: #10b981;">${Number(pool.apr).toFixed(2)}%</td>

            <td>

                <span style="background: ${badgeColor}22; color: ${badgeColor}; padding: 4px 12px; border-radius: 20px; border: 1px solid ${badgeColor}; font-size: 0.8rem;">

                    ${Math.round(pool.risk_score)}/100

                </span>

            </td>

        `;

        row.onclick = () => showDetails(pool.address);

        tableBody.appendChild(row);

    });

}



async function showDetails(address) {

    const detailsContainer = document.getElementById('details-panel');

    detailsContainer.innerHTML = `<p style="text-align:center; padding:50px;">üì° Fetching Intelligence...</p>`;

    try {

        const res = await fetch(`${API_URL}/pool/${address}`);

        const data = await res.json();

        const { pool, history } = data;

        let advice = pool.risk_score > 40 ? "High Volatility. Monitor for Impermanent Loss." : "Consolidation phase. Safe for Fee Harvesting.";

        detailsContainer.innerHTML = `

            <div class="fade-in">

                <h3 style="color:var(--accent)">${pool.token_a} / ${pool.token_b}</h3>

                <div style="margin-bottom:15px;"><span class="tag ${pool.risk_score > 40 ? 'risk-high' : 'risk-low'}">AI SIGNAL: ${advice}</span></div>

                <div class="chart-box"><canvas id="priceChart"></canvas></div>

                <div class="calc-section">

                    <h4>üßÆ Smart IL Simulator</h4>

                    <div class="calc-input-group">

                        <label>Investment Amount ($)</label>

                        <input type="number" id="simAmount" class="calc-input" value="1000">

                    </div>

                    <div class="calc-input-group">

                        <label>Predicted Price Shift (%)</label>

                        <input type="range" id="simChange" min="-90" max="200" value="20" style="width:100%" oninput="this.nextElementSibling.value = this.value + '%'">

                        <output style="color:var(--accent)">20%</output>

                    </div>

                    <button class="btn" style="width:100%; margin-top:10px;" onclick="runSimulation()">Calculate Projected Risk</button>

                    <div id="sim-results"></div>

                </div>

            </div>

        `;

        renderChart(history);

    } catch (err) { detailsContainer.innerHTML = `<p style="color: var(--danger)">Failed to load intelligence.</p>`; }

}



function renderChart(history) {

    const canvas = document.getElementById('priceChart');

    if (!canvas) return;

    const ctx = canvas.getContext('2d');

    if (charts.price) charts.price.destroy();

    charts.price = new Chart(ctx, {

        type: 'line',

        data: {

            labels: history.map(h => new Date(h.timestamp).toLocaleTimeString()),

            datasets: [{ label: 'Price Ratio', data: history.map(h => h.price_ratio), borderColor: '#23f7dd', tension: 0.4, fill: false }]

        },

        options: { responsive: true, maintainAspectRatio: false }

    });

}



function runSimulation() {

    const amount = parseFloat(document.getElementById('simAmount').value);

    const change = parseFloat(document.getElementById('simChange').value);

    const r = 1 + (change / 100);

    const ilDecimal = (2 * Math.sqrt(r)) / (1 + r) - 1;

    const ilPercentage = (Math.abs(ilDecimal) * 100).toFixed(2);

    const lossUsd = (amount * Math.abs(ilDecimal)).toFixed(2);

    document.getElementById('sim-results').innerHTML = `

        <div class="result-box" style="border-color: var(--danger); background: rgba(244, 63, 94, 0.05);">

            <div style="color: var(--danger); font-weight: bold; font-size: 1.1rem;">Projected IL: -${ilPercentage}% (-$${lossUsd})</div>

            <p style="font-size: 0.8rem; color: #94a3b8; margin-top: 8px; line-height: 1.4;">

                ‚ö†Ô∏è <strong>Strategy Note:</strong> To be profitable, your earnings from this pool <span style="color: var(--accent)">must be offset by >${ilPercentage}%</span> in trading fees/rewards.

            </p>

        </div>

    `;

}



fetchPools();
</script>

</body>

</html>